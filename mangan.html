<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kalkulator Urunan</title>
    <style>
        /* reset ringan */
        *,
        *::before,
        *::after {
            box-sizing: border-box
        }

        :root {
            --bg: #0f172a;
            --panel: #1f2937;
            --panel2: #111827;
            --text: #e5e7eb;
            --muted: #94a3b8;
            --border: #374151;
            --accent: #2563eb;
            --danger: #ef4444;
            --danger-bg: #3b1a1a;
            --r: 14px;
            --pad: 18px;
            --g: 14px;
            --cell: 10px;
        }

        html,
        body {
            background: var(--bg);
            color: var(--text);
            font: 14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 22px
        }

        /* blok umum */
        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: var(--pad)
        }

        .panel+.panel {
            margin-top: 18px
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 0 6px
        }

        h3 {
            margin: 0;
            font-weight: 800
        }

        .muted {
            color: var(--muted)
        }

        .grid {
            display: grid;
            gap: var(--g)
        }

        .g-2 {
            grid-template-columns: 1fr 1fr
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap
        }

        .stack>*+* {
            margin-top: var(--g)
        }

        .ghost {
            opacity: .7
        }

        /* controls */
        input,
        select,
        button {
            font: inherit
        }

        .input {
            width: 100%;
            padding: 12px 14px;
            background: #0b1220;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 12px
        }

        .input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, .25)
        }

        .btn {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: #0b1220;
            color: var(--text);
            cursor: pointer
        }

        .btn:hover {
            border-color: #4b5563
        }

        .btn-primary {
            background: var(--accent);
            border-color: #1d4ed8
        }

        .btn-primary:hover {
            background: #1d4ed8
        }

        .btn-danger {
            border-color: #7f1d1d;
            background: var(--danger-bg);
            color: #fecaca
        }

        .btn-danger:hover {
            background: #b91c1c;
            color: #fff
        }

        /* kartu peserta */
        .card {
            background: var(--panel2);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: var(--pad)
        }

        .card+.card {
            margin-top: var(--g)
        }

        .person-top {
            display: grid;
            grid-template-columns: 44px 1fr auto auto;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 999px;
            background: #0b1220;
            border: 1px solid var(--border);
            display: grid;
            place-items: center
        }

        .avatar span {
            font-size: 18px
        }

        .person-actions .btn {
            margin-left: 8px
        }

        .item-row {
            display: grid;
            gap: var(--g);
            align-items: center;
            grid-template-columns: minmax(180px, 1.6fr) minmax(110px, .9fr) minmax(90px, .7fr) 90px;
            padding: var(--cell);
            border: 1px solid var(--border);
            border-radius: 12px;
            background: #0b1220;
        }

        .item-row+.item-row {
            margin-top: 10px
        }

        /* diskon & biaya tambahan */
        .discount-row {
            display: grid;
            gap: var(--g);
            align-items: end;
            grid-template-columns: 100px minmax(180px, 1fr) 90px;
            padding: var(--cell);
            border: 1px dashed var(--border);
            border-radius: 12px;
            background: #0f1a2b;
        }

        .fee-col .input {
            width: 100%
        }

        /* ringkasan */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0
        }

        th,
        td {
            padding: 10px 10px;
            text-align: left
        }

        th {
            color: var(--muted);
            font-weight: 600
        }

        tr+tr td {
            border-top: 1px solid var(--border)
        }

        .right {
            text-align: right
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- PESANAN -->
        <section class="panel">
            <div class="panel-header">
                <h3>Pesanan</h3>
                <div class="row">
                    <button id="addPerson" class="btn btn-primary">Tambah Peserta</button>
                    <button id="resetAll" class="btn">Reset</button>
                </div>
            </div>

            <div id="people" class="stack"></div>
        </section>

        <!-- DISKON & BIAYA TAMBAHAN -->
        <section class="panel">
            <div class="grid g-2">
                <div class="stack">
                    <h3>Diskon</h3>
                    <div id="discountList" class="stack"></div>
                    <button id="addDiscount" class="btn" style="width:max-content">Tambah</button>
                </div>

                <div class="stack">
                    <h3>Biaya tambahan</h3>
                    <div class="fee-col">
                        <input id="fee_shipping" class="input" type="number" step="0.01" placeholder="Ongkos kirim">
                    </div>
                    <div class="fee-col">
                        <input id="fee_service" class="input" type="number" step="0.01"
                            placeholder="Biaya layanan (opsional)">
                    </div>
                    <div class="fee-col">
                        <input id="fee_pack" class="input" type="number" step="0.01"
                            placeholder="Biaya pengemasan (opsional)">
                    </div>
                    <div class="fee-col">
                        <input id="fee_other" class="input" type="number" step="0.01"
                            placeholder="Biaya lain-lain (opsional)">
                    </div>
                </div>
            </div>
        </section>

        <!-- RINGKASAN GLOBAL -->
        <section class="panel">
            <h3>Ringkasan</h3>
            <table>
                <tbody>
                    <tr>
                        <td>Sub total</td>
                        <td class="right" id="sumItems">Rp 0</td>
                    </tr>
                    <tr>
                        <td>Diskon</td>
                        <td class="right" id="discountTotal">Rp 0</td>
                    </tr>
                    <tr>
                        <td>Ongkos kirim</td>
                        <td class="right" id="sum_ship">Rp 0</td>
                    </tr>
                    <tr>
                        <td>Biaya layanan</td>
                        <td class="right" id="sum_service">Rp 0</td>
                    </tr>
                    <tr>
                        <td>Biaya Pengemasan</td>
                        <td class="right" id="sum_pack">Rp 0</td>
                    </tr>
                    <tr>
                        <td>Biaya lain-lain</td>
                        <td class="right" id="sum_other">Rp 0</td>
                    </tr>
                    <tr>
                        <td style="font-weight:800">Grand total</td>
                        <td class="right" style="font-weight:800" id="grandTotal">Rp 0</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- RINGKASAN PER ORANG -->
        <section class="panel">
            <h3>Ringkasan Per Orang</h3>
            <table>
                <thead>
                    <tr>
                        <th>Nama</th>
                        <th class="right">Sub total</th>
                        <th class="right">Biaya</th>
                        <th class="right">Diskon</th>
                        <th class="right">Total</th>
                    </tr>
                </thead>
                <tbody id="perPerson"></tbody>
            </table>
        </section>
    </div>

    <script>
        (() => {
            const fmt = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' });
            const $ = (id) => document.getElementById(id);

            /* ================== STATE ================== */
            let state = {
                people: [], // {name:'', items:[{name:'', price:'', qty:'1'}]}
                discounts: [{ type: 'Rp', value: '' }], // tampil 1 baris sesuai sketsa
                fees: { shipping: '', service: '', pack: '', other: '' } // nominal
            };

            /* ================== RENDER PEOPLE ================== */
            const peopleWrap = $('people');

            function renderPeople() {
                peopleWrap.innerHTML = '';
                state.people.forEach((p, pidx) => {
                    const card = document.createElement('div');
                    card.className = 'card';

                    // header kartu orang
                    const header = document.createElement('div');
                    header.className = 'person-top';
                    header.innerHTML = `
        <div class="avatar"><span>ðŸ‘¤</span></div>
        <input type="text" class="input" placeholder="Nama" value="${esc(p.name)}"
               data-role="person-name" data-pidx="${pidx}">
        <div class="person-actions">
          <button class="btn" data-role="add-item" data-pidx="${pidx}">Tambah +</button>
          <button class="btn" data-role="reset-person" data-pidx="${pidx}">Reset</button>
        </div>
      `;
                    card.appendChild(header);

                    // item list
                    const box = document.createElement('div');
                    p.items.forEach((it, iidx) => {
                        const row = document.createElement('div');
                        row.className = 'item-row';
                        row.innerHTML = `
          <input type="text" class="input" placeholder="Nama item"
                 value="${esc(it.name)}" data-role="item-name" data-pidx="${pidx}" data-iidx="${iidx}">
          <input type="number" step="0.01" class="input" placeholder="0"
                 value="${esc(it.price)}" data-role="item-price" data-pidx="${pidx}" data-iidx="${iidx}">
          <input type="number" step="1" class="input" placeholder="1"
                 value="${esc(it.qty ?? '1')}" data-role="item-qty" data-pidx="${pidx}" data-iidx="${iidx}">
          <button class="btn btn-danger" data-role="remove-item" data-pidx="${pidx}" data-iidx="${iidx}">X</button>
        `;
                        box.appendChild(row);
                    });
                    card.appendChild(box);
                    peopleWrap.appendChild(card);
                });
            }

            peopleWrap.addEventListener('input', (e) => {
                const role = e.target.getAttribute('data-role'); if (!role) return;
                const pidx = +e.target.getAttribute('data-pidx');
                if (role === 'person-name') { state.people[pidx].name = e.target.value; renderTotals(); return; }
                const iidx = +e.target.getAttribute('data-iidx');
                if (role === 'item-name') state.people[pidx].items[iidx].name = e.target.value;
                if (role === 'item-price') state.people[pidx].items[iidx].price = e.target.value;
                if (role === 'item-qty') state.people[pidx].items[iidx].qty = e.target.value;
                renderTotals();
            });
            peopleWrap.addEventListener('click', (e) => {
                const role = e.target.getAttribute('data-role'); if (!role) return;
                const pidx = +e.target.getAttribute('data-pidx');
                if (role === 'add-item') { state.people[pidx].items.push({ name: '', price: '', qty: '1' }); renderPeople(); renderTotals(); }
                if (role === 'reset-person') { state.people[pidx].items = []; renderPeople(); renderTotals(); }
                if (role === 'remove-item') { const iidx = +e.target.getAttribute('data-iidx'); state.people[pidx].items.splice(iidx, 1); renderPeople(); renderTotals(); }
            });

            $('addPerson').addEventListener('click', () => {
                state.people.push({ name: '', items: [{ name: '', price: '', qty: '1' }] });
                renderPeople(); renderTotals();
            });
            $('resetAll').addEventListener('click', () => {
                state = { people: [], discounts: [{ type: 'Rp', value: '' }], fees: { shipping: '', service: '', pack: '', other: '' } };
                renderPeople(); renderDiscounts(); renderFees(); renderTotals();
            });

            /* ================== DISCOUNT ================== */
            const discountList = $('discountList');
            function renderDiscounts() {
                discountList.innerHTML = '';
                state.discounts.forEach((d, idx) => {
                    const row = document.createElement('div');
                    row.className = 'discount-row';
                    row.innerHTML = `
        <div>
          <label class="muted">Tipe</label>
          <select class="input" data-role="disc-type" data-idx="${idx}">
            <option value="Rp" ${d.type === 'Rp' ? 'selected' : ''}>Rp.</option>
            <option value="%"  ${d.type === '%' ? 'selected' : ''}>%</option>
          </select>
        </div>
        <div>
          <label class="muted">Nilai</label>
          <input class="input" type="number" step="0.01" value="${esc(d.value)}"
                 placeholder="0" data-role="disc-value" data-idx="${idx}">
        </div>
        <div>
          <label class="muted">&nbsp;</label>
          <button class="btn btn-danger" data-role="disc-remove" data-idx="${idx}">X</button>
        </div>
      `;
                    discountList.appendChild(row);
                });
            }
            $('addDiscount').addEventListener('click', () => {
                state.discounts.push({ type: 'Rp', value: '' });
                renderDiscounts(); renderTotals();
            });
            discountList.addEventListener('input', (e) => {
                const role = e.target.getAttribute('data-role'); if (!role) return;
                const i = +e.target.getAttribute('data-idx');
                if (role === 'disc-type') state.discounts[i].type = e.target.value;
                if (role === 'disc-value') state.discounts[i].value = e.target.value;
                renderTotals();
            });
            discountList.addEventListener('click', (e) => {
                if (e.target.getAttribute('data-role') === 'disc-remove') {
                    const i = +e.target.getAttribute('data-idx');
                    state.discounts.splice(i, 1);
                    if (!state.discounts.length) state.discounts.push({ type: 'Rp', value: '' });
                    renderDiscounts(); renderTotals();
                }
            });

            /* ================== FEES ================== */
            function renderFees() {
                $('fee_shipping').value = state.fees.shipping || '';
                $('fee_service').value = state.fees.service || '';
                $('fee_pack').value = state.fees.pack || '';
                $('fee_other').value = state.fees.other || '';
            }
            ['fee_shipping', 'fee_service', 'fee_pack', 'fee_other'].forEach(id => {
                $(id).addEventListener('input', e => {
                    const m = { fee_shipping: 'shipping', fee_service: 'service', fee_pack: 'pack', fee_other: 'other' };
                    state.fees[m[id]] = e.target.value;
                    renderTotals();
                });
            });

            /* ================== COMPUTE ================== */
            function compute() {
                // subtotal per orang
                const subs = state.people.map(p => {
                    let s = 0; (p.items || []).forEach(it => {
                        const price = num(it.price), qty = Math.max(1, Math.floor(num(it.qty) || 0) || 1);
                        s += price * qty;
                    });
                    return { name: p.name || '', subtotal: s };
                });
                const sumItems = subs.reduce((a, s) => a + s.subtotal, 0);

                // diskon gabungan
                let pct = 0, flat = 0;
                state.discounts.forEach(d => { if (d.type === '%') pct += num(d.value); else flat += num(d.value); });
                const discountTotal = Math.min(sumItems, (sumItems * pct) / 100 + flat);
                const afterDiscount = sumItems - discountTotal;

                // biaya tambahan (semua nominal, proporsional ke subtotal)
                const fees = {
                    shipping: num(state.fees.shipping),
                    service: num(state.fees.service),
                    pack: num(state.fees.pack),
                    other: num(state.fees.other),
                };
                const extrasFlat = fees.shipping + fees.service + fees.pack + fees.other;

                const allocations = subs.map(s => ({ name: s.name, items: s.subtotal, extras: 0, discount: 0, total: 0 }));
                if (sumItems > 0) {
                    for (const a of allocations) {
                        const r = a.items / sumItems || 0;
                        a.discount = - discountTotal * r;
                        a.extras = extrasFlat * r;
                        a.total = r2(a.items + a.extras + a.discount);
                    }
                }

                return {
                    sumItems: r2(sumItems),
                    discountTotal: r2(discountTotal),
                    fees: { shipping: r2(fees.shipping), service: r2(fees.service), pack: r2(fees.pack), other: r2(fees.other) },
                    grandTotal: r2(afterDiscount + extrasFlat),
                    perPerson: allocations
                };
            }

            function renderTotals() {
                const r = compute();
                $('sumItems').textContent = fmt.format(r.sumItems);
                $('discountTotal').textContent = '-' + fmt.format(r.discountTotal);
                $('sum_ship').textContent = fmt.format(r.fees.shipping);
                $('sum_service').textContent = fmt.format(r.fees.service);
                $('sum_pack').textContent = fmt.format(r.fees.pack);
                $('sum_other').textContent = fmt.format(r.fees.other);
                $('grandTotal').textContent = fmt.format(r.grandTotal);

                const tbody = $('perPerson'); tbody.innerHTML = '';
                r.perPerson.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
        <td>${esc(p.name)}</td>
        <td class="right">${fmt.format(p.items)}</td>
        <td class="right">${fmt.format(p.extras)}</td>
        <td class="right">${fmt.format(p.discount)}</td>
        <td class="right">${fmt.format(p.total)}</td>`;
                    tbody.appendChild(tr);
                });
            }

            /* ================== UTILS ================== */
            const num = (x) => Number((x ?? '').toString().trim() || 0);
            const r2 = (n) => Math.round(n * 100) / 100;
            const esc = (s) => String(s ?? '').replace(/[&<>\"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));

            /* init */
            renderPeople();
            renderDiscounts();
            renderFees();
            renderTotals();
        })();
    </script>
</body>

</html>